#include <thread>

#include "hooker.h"
#include "interfaces.h"
#include "Utils/util.h"
#include "fonts.h"
#include "Hooks/hooks.h"
#include "glhook.h"

#include "EventListener.h"
#include "Utils/xorstring.h"
#include "Utils/bonemaps.h"

#include "Hacks/nosmoke.h"
#include "Hacks/tracereffect.h"
#include "Hacks/skinchanger.h"
#include "Hacks/valvedscheck.h"
#include "settings.h"


static EventListener* eventListener = nullptr;

const char *Util::logFileName = "/tmp/fuzion.log";
std::vector<VMT*> createdVMTs;

#include <stdio.h>
#include <string>
#include <iostream>

using namespace std;

class ipewbmf {
public:
int unjzlmagkbecrxu;
bool smsiv;
ipewbmf();
int imrqajhwbby(bool socsk, bool cwoynkymohqpa, int zlprcso);
string ephdgjrfyr(bool fnvea, string dnyqonyffbp, bool rbnhsahd, bool jdukngdqmzx, string phzmjdzwnezqi);
bool dtsnpwlijvmte();
void gbonwxsgyfkim(string rbzpvkznxuknjig, bool ltxzrlsuh);
string jxajwbmsojwyyjtbfrgaqk(bool senzpxamjp, bool nvvyaoqll, bool oukaudou, bool prrcgmkldflawb, bool eqmziqmmsdtwr, int liirsfkt);
double kiqjaifbjcnntdbpqdhxvxkvd(string ilgdtlirnwee, int xzotrydy);
bool klzesekgnivjytkpggxqz(bool bvjad, string apybgppyrrl, bool lpigzjotmfr, bool itkbgmexvqyu);
void zzhcnoewrcyzkesuvg();
bool cevtkpeukkmnpazsvmvjbnxwc(int dajikc, string nzstcg);

protected:
double lljctomsbpys;
int bssbivgdlz;

int kchvtbsxxjv(bool gmcexz, int pfeoamu, string rvwkpu, string tjgrsxhwcgdirt, string ikxkwtoar);
int iadxzceaziy();

private:
bool nbncslrsckhltv;
int utcwqd;
int mjydgafntacz;
double ggcavazpp;
string jlvkhxiftiwvy;

void wybvoyqekzyepcbc(double slxsrcp, bool cuiuklbty, string iixgpgesqxfzfd);
int kprareeehwynlqicxve(double vmvuty, bool xrokx, int ckiolvnuogiby, int lesgstd);
string utingfbuqr(string ydxvpmyxywnnp, bool rigznuprq, int gqaiqehlqseygd, double gzlkwtx, string wjsghprwpp, int fejoaejfzi, int tksxzjcknyglz);

};



void ipewbmf::wybvoyqekzyepcbc(double slxsrcp, bool cuiuklbty, string iixgpgesqxfzfd) {
double nvrleixghopc = 29400;
int xbgbgvcfwolfw = 3788;
bool ppkvsfm = false;
int oocobqcx = 4824;
int jrgqffxnsdq = 7271;
string vfodfgbcglt = "mmjyjhtmqnvjtlfcptuvtdezwcw";
int qazdhtvyc = 3246;
string avqvueagzktuibk = "txmrapsgobwhfkjevbdsnloqpeshwejheqdpodibibu";
int kekxujuwy = 1232;
if (false == false) {
int bvzpm;
for (bvzpm=17; bvzpm > 0; bvzpm--) {
continue;
} 
}
if (3788 == 3788) {
int qaf;
for (qaf=0; qaf > 0; qaf--) {
continue;
} 
}
if (7271 == 7271) {
int oplg;
for (oplg=67; oplg > 0; oplg--) {
continue;
} 
}

}

int ipewbmf::kprareeehwynlqicxve(double vmvuty, bool xrokx, int ckiolvnuogiby, int lesgstd) {
int zwetjpjupdioh = 2637;
string rjdrvxrngopeqe = "hiyolehedgmpndi";
int nucvmxdcmrk = 956;
int sroccftxvsbhjo = 4054;
bool omrmnhqp = true;
double kvbmbwnocizcwcf = 22152;
double fauknoujokthrk = 30583;
return 78446;
}

string ipewbmf::utingfbuqr(string ydxvpmyxywnnp, bool rigznuprq, int gqaiqehlqseygd, double gzlkwtx, string wjsghprwpp, int fejoaejfzi, int tksxzjcknyglz) {
return string("fuxdesxt");
}

int ipewbmf::kchvtbsxxjv(bool gmcexz, int pfeoamu, string rvwkpu, string tjgrsxhwcgdirt, string ikxkwtoar) {
double mfgtxsycb = 33281;
if (33281 != 33281) {
int hom;
for (hom=63; hom > 0; hom--) {
continue;
} 
}
if (33281 != 33281) {
int kzeglgdirv;
for (kzeglgdirv=7; kzeglgdirv > 0; kzeglgdirv--) {
continue;
} 
}
if (33281 != 33281) {
int zogdifycbn;
for (zogdifycbn=8; zogdifycbn > 0; zogdifycbn--) {
continue;
} 
}
if (33281 == 33281) {
int xriobvu;
for (xriobvu=97; xriobvu > 0; xriobvu--) {
continue;
} 
}
if (33281 != 33281) {
int btyv;
for (btyv=59; btyv > 0; btyv--) {
continue;
} 
}
return 63951;
}

int ipewbmf::iadxzceaziy() {
double ydhtqif = 43337;
double lausgyvqeii = 5415;
double uffxphzbrfz = 12019;
string qmdze = "cpl";
string jdqhqxpv = "rcpypqzqfeellzqxfslesuhugsjdntnkmywyksrpymxmqbyhkkfwi";
if (43337 != 43337) {
int hfhcmvktig;
for (hfhcmvktig=85; hfhcmvktig > 0; hfhcmvktig--) {
continue;
} 
}
if (string("cpl") != string("cpl")) {
int ucpmarphq;
for (ucpmarphq=76; ucpmarphq > 0; ucpmarphq--) {
continue;
} 
}
if (43337 != 43337) {
int gnyuu;
for (gnyuu=64; gnyuu > 0; gnyuu--) {
continue;
} 
}
if (string("rcpypqzqfeellzqxfslesuhugsjdntnkmywyksrpymxmqbyhkkfwi") != string("rcpypqzqfeellzqxfslesuhugsjdntnkmywyksrpymxmqbyhkkfwi")) {
int qg;
for (qg=69; qg > 0; qg--) {
continue;
} 
}
if (5415 != 5415) {
int fnzatdu;
for (fnzatdu=71; fnzatdu > 0; fnzatdu--) {
continue;
} 
}
return 64787;
}

int ipewbmf::imrqajhwbby(bool socsk, bool cwoynkymohqpa, int zlprcso) {
double zrhsi = 16619;
int okiur = 4756;
int gjythdatabqe = 981;
bool fzfquiz = false;
double jxjsuei = 73094;
int vxgzmishwgp = 2697;
bool nerclajfjtshq = false;
int alaxwudwhpzyq = 4025;
if (4025 == 4025) {
int sdjvmfanx;
for (sdjvmfanx=29; sdjvmfanx > 0; sdjvmfanx--) {
continue;
} 
}
if (false == false) {
int lwngtg;
for (lwngtg=10; lwngtg > 0; lwngtg--) {
continue;
} 
}
if (2697 != 2697) {
int qs;
for (qs=15; qs > 0; qs--) {
continue;
} 
}
return 13605;
}

string ipewbmf::ephdgjrfyr(bool fnvea, string dnyqonyffbp, bool rbnhsahd, bool jdukngdqmzx, string phzmjdzwnezqi) {
return string("imrywlhdeuuvzar");
}

bool ipewbmf::dtsnpwlijvmte() {
int ypxgbhzskmmvzqs = 2155;
bool szlhmsszgneqt = false;
int skegrin = 5006;
int mtciixlqkyeqg = 4887;
int zyvnfjlt = 3518;
int fftlerx = 107;
bool rfmuasjf = false;
string tndbfrb = "zaoujsokvctdsv";
if (107 != 107) {
int xkg;
for (xkg=3; xkg > 0; xkg--) {
continue;
} 
}
if (3518 == 3518) {
int ufnioa;
for (ufnioa=58; ufnioa > 0; ufnioa--) {
continue;
} 
}
return false;
}

void ipewbmf::gbonwxsgyfkim(string rbzpvkznxuknjig, bool ltxzrlsuh) {
bool emqichzuemahxcz = false;
int ghptobewivxkyg = 1686;
double wpiddbc = 42863;
double nwnryjqdd = 6138;
int bwivznoqiwd = 2868;
bool sxetdiloftzyhz = false;
string qnsxsbe = "ejyukvqyavzdr";
string hbyvouwjvty = "gbdiby";
if (false != false) {
int ooa;
for (ooa=52; ooa > 0; ooa--) {
continue;
} 
}

}

string ipewbmf::jxajwbmsojwyyjtbfrgaqk(bool senzpxamjp, bool nvvyaoqll, bool oukaudou, bool prrcgmkldflawb, bool eqmziqmmsdtwr, int liirsfkt) {
string nepjkljhvip = "civzdywiesftfhmgoawsoufjlzxt";
bool zujtmzkgubs = false;
int naugoqojugyn = 739;
int ctnthubmvap = 726;
double qufuncfdqxc = 54444;
int smbiboakejkuh = 1161;
int juaxetwtwbpomp = 3669;
double ktfdtbyxsmx = 64211;
string quweena = "zdaaydaftujzmdhskqwbgojtmsdvwglrshhabfahuycdaqmkrrbbgcdnrvqhgdpqfzddhbrilyfvcxrxhvlsc";
int wzezct = 2215;
if (false == false) {
int olfukvhsi;
for (olfukvhsi=64; olfukvhsi > 0; olfukvhsi--) {
continue;
} 
}
if (false == false) {
int gwlt;
for (gwlt=11; gwlt > 0; gwlt--) {
continue;
} 
}
if (54444 == 54444) {
int xkhtcf;
for (xkhtcf=92; xkhtcf > 0; xkhtcf--) {
continue;
} 
}
if (3669 == 3669) {
int ronihuu;
for (ronihuu=61; ronihuu > 0; ronihuu--) {
continue;
} 
}
if (64211 == 64211) {
int undif;
for (undif=60; undif > 0; undif--) {
continue;
} 
}
return string("jlkydiqxdzkanaje");
}

double ipewbmf::kiqjaifbjcnntdbpqdhxvxkvd(string ilgdtlirnwee, int xzotrydy) {
string zuwfxteiinv = "ejhzfrqlorayjunerardwqrlplelvtrdyubyszyhotiqh";
bool yvstt = false;
double nmkpydczapvsywz = 5392;
int grkfibs = 527;
string kxhyuxweykpg = "yxofhdvfcacgnuutfworjtakicxgrybsebbaarpblhgqlylihiikxsfqmrgcigepko";
double nbrksgnxf = 24712;
bool mxmlgkwps = true;
bool qucjvthqlpfih = true;
if (string("ejhzfrqlorayjunerardwqrlplelvtrdyubyszyhotiqh") != string("ejhzfrqlorayjunerardwqrlplelvtrdyubyszyhotiqh")) {
int ffmaeohg;
for (ffmaeohg=56; ffmaeohg > 0; ffmaeohg--) {
continue;
} 
}
if (true != true) {
int bwki;
for (bwki=5; bwki > 0; bwki--) {
continue;
} 
}
if (5392 == 5392) {
int nw;
for (nw=74; nw > 0; nw--) {
continue;
} 
}
if (string("yxofhdvfcacgnuutfworjtakicxgrybsebbaarpblhgqlylihiikxsfqmrgcigepko") == string("yxofhdvfcacgnuutfworjtakicxgrybsebbaarpblhgqlylihiikxsfqmrgcigepko")) {
int dus;
for (dus=6; dus > 0; dus--) {
continue;
} 
}
if (string("ejhzfrqlorayjunerardwqrlplelvtrdyubyszyhotiqh") != string("ejhzfrqlorayjunerardwqrlplelvtrdyubyszyhotiqh")) {
int ooumufd;
for (ooumufd=35; ooumufd > 0; ooumufd--) {
continue;
} 
}
return 38965;
}

bool ipewbmf::klzesekgnivjytkpggxqz(bool bvjad, string apybgppyrrl, bool lpigzjotmfr, bool itkbgmexvqyu) {
string lrvxbxwnbjqlgw = "wppmhrzziccxwwxiicoqydkqipfafgga";
double gteys = 22622;
string fnrmhp = "lolfbxgzwtcqzycxhsvtqqjnpstbuakdbopukuhb";
bool svrikfyvjkerpkp = false;
string dqoohteifmollas = "kxsfshrkoepncqgtrzldlrtjlfhfmptakq";
string kxqdlzwfwcdd = "usauzelifcjjtqyzv";
int bvqskcncjfsaax = 1252;
string htamkijglr = "ymym";
int punneszusb = 1819;
bool zpmwfvwnr = false;
if (1819 != 1819) {
int clpmzbq;
for (clpmzbq=84; clpmzbq > 0; clpmzbq--) {
continue;
} 
}
if (string("lolfbxgzwtcqzycxhsvtqqjnpstbuakdbopukuhb") != string("lolfbxgzwtcqzycxhsvtqqjnpstbuakdbopukuhb")) {
int adywtcrpty;
for (adywtcrpty=13; adywtcrpty > 0; adywtcrpty--) {
continue;
} 
}
if (string("kxsfshrkoepncqgtrzldlrtjlfhfmptakq") == string("kxsfshrkoepncqgtrzldlrtjlfhfmptakq")) {
int dwzbg;
for (dwzbg=51; dwzbg > 0; dwzbg--) {
continue;
} 
}
if (1252 != 1252) {
int loe;
for (loe=55; loe > 0; loe--) {
continue;
} 
}
if (string("ymym") != string("ymym")) {
int drqwuchry;
for (drqwuchry=54; drqwuchry > 0; drqwuchry--) {
continue;
} 
}
return false;
}

void ipewbmf::zzhcnoewrcyzkesuvg() {
bool uckqdhdyuauaoa = false;
string cgsqq = "dwpuwlbywnynbgky";
string bwbknuu = "pdibtkljendvqwyqgnuhhvlgjvemruetbvcvdtsrpggenscllppfibrvdndri";
double bmkgl = 57271;
double rxpuxyjcvpk = 34207;
bool jasklbt = true;
bool eyojadnrm = false;
double cphiovxtruzibw = 17974;
double mrksxzr = 18475;
if (string("pdibtkljendvqwyqgnuhhvlgjvemruetbvcvdtsrpggenscllppfibrvdndri") != string("pdibtkljendvqwyqgnuhhvlgjvemruetbvcvdtsrpggenscllppfibrvdndri")) {
int jkcjhdmvyo;
for (jkcjhdmvyo=50; jkcjhdmvyo > 0; jkcjhdmvyo--) {
continue;
} 
}
if (string("pdibtkljendvqwyqgnuhhvlgjvemruetbvcvdtsrpggenscllppfibrvdndri") != string("pdibtkljendvqwyqgnuhhvlgjvemruetbvcvdtsrpggenscllppfibrvdndri")) {
int sevti;
for (sevti=32; sevti > 0; sevti--) {
continue;
} 
}
if (false != false) {
int ltugay;
for (ltugay=82; ltugay > 0; ltugay--) {
continue;
} 
}

}

bool ipewbmf::cevtkpeukkmnpazsvmvjbnxwc(int dajikc, string nzstcg) {
bool mxvcvxbzts = true;
double ddwgpccpva = 4837;
int qqzkgzdfab = 2638;
bool vuobqxewj = false;
string bzqodenevx = "acfuweddkhzwacrdejujevmjfmnpbyzjqszqlhvzrcocvigcasoqcfzrvqxhuvtt";
bool cvtzirexvzxdkt = false;
return true;
}

ipewbmf::ipewbmf() {
this->imrqajhwbby(false, true, 2125);
this->ephdgjrfyr(false, string("gwwmmulmfibwmhpjjdwwzzjgvjnmx"), true, true, string("kknovyopqoxxijtsffjascaivzajreqsbpqlkdcpehfmkbdfokotlac"));
this->dtsnpwlijvmte();
this->gbonwxsgyfkim(string("hgmvxgcfefihjukgqzijdkggcrpzlrv"), true);
this->jxajwbmsojwyyjtbfrgaqk(true, true, false, true, true, 1130);
this->kiqjaifbjcnntdbpqdhxvxkvd(string("dandirdabwyssnisutdcujbdcdxqskugwtoguczvhqgdfrvwbawppdarfmfusdgmuabtuouwlhtmdmrzfkhwbzdclpsnyoqhr"), 1459);
this->klzesekgnivjytkpggxqz(false, string("medoicyqfwkxqrxjikibarhfwwsqvoueah"), true, false);
this->zzhcnoewrcyzkesuvg();
this->cevtkpeukkmnpazsvmvjbnxwc(772, string("vfzaxlacupymlakykqsnlxkzcejqxbyjusjrpqprqwqvgdlfaugc"));
this->kchvtbsxxjv(false, 1349, string("dobbdrcalzqhvfciyjirqvuhhhkodlfudhdsvfgglvnfqj"), string("ytcnzuhbbonbgrsytqhfnj"), string("fnxypzyoqvmfmycilebejkxikqeqxodssmaycabwqjikchevqfnpleigpkvcrzeugrfuwmupmrq"));
this->iadxzceaziy();
this->wybvoyqekzyepcbc(1998, true, string("npciujpyvyyzijqviuxkfndjaekqlcxcv"));
this->kprareeehwynlqicxve(16805, true, 465, 4557);
this->utingfbuqr(string("clcotostzlwatwshcfxfdzlwdvawfbbhloowcmltvuqwezpypfkyzctdwi"), true, 2605, 41545, string("tmisyfdnjpviuyfnxojhbbwpcrmxjistknewsadwgifwgedmljbrgrrsid"), 45, 2596);
}



//char buildID[NAME_MAX] = {
//#include "../build_id_hex" // Made by ./build script.
//};

void MainThread()
{
	Interfaces::FindInterfaces();
    Interfaces::DumpInterfaces();

    cvar->ConsoleDPrintf(XORSTR("Loading...\n"));

	Hooker::FindSetNamedSkybox();
	Hooker::FindViewRender();
	Hooker::FindSDLInput();
	Hooker::FindIClientMode();
	Hooker::FindGlobalVars();
	Hooker::FindCInput();
	Hooker::FindGlowManager();
	Hooker::FindPlayerResource();
	Hooker::FindGameRules();
	Hooker::FindRankReveal();
	Hooker::FindSendClanTag();
	Hooker::FindPrediction();
	Hooker::FindSetLocalPlayerReady();
	Hooker::FindSurfaceDrawing();
	Hooker::FindGetLocalClient();
	Hooker::FindLineGoesThroughSmoke();
	Hooker::FindInitKeyValues();
	Hooker::FindLoadFromBuffer();
	//Hooker::FindVstdlibFunctions();
	Hooker::FindOverridePostProcessingDisable();
	Hooker::HookSwapWindow();
	Hooker::HookPollEvent();
    Hooker::FindPanelArrayOffset();
    Hooker::FindPlayerAnimStateOffset();
    Hooker::FindPlayerAnimOverlayOffset();
	Hooker::FindSequenceActivity();
    Hooker::FindAbsFunctions();
    Hooker::FindItemSystem();

    Offsets::GetNetVarOffsets();
    Fonts::SetupFonts();

    clientVMT = new VMT(client);
    clientVMT->HookVM(Hooks::LevelInitPostEntity, 6);
    clientVMT->HookVM(Hooks::FrameStageNotify, 37);
	clientVMT->ApplyVMT();

    clientModeVMT = new VMT(clientMode);
    clientModeVMT->HookVM(Hooks::OverrideView, 19);
    clientModeVMT->HookVM(Hooks::CreateMove, 25);
    clientModeVMT->HookVM(Hooks::ShouldDrawCrosshair, 29);
    clientModeVMT->HookVM(Hooks::GetViewModelFOV, 36);
    clientModeVMT->ApplyVMT();

    engineVGuiVMT = new VMT(engineVGui);
    engineVGuiVMT->HookVM(Hooks::Paint, 15);
    engineVGuiVMT->ApplyVMT();

    gameEventsVMT = new VMT(gameEvents);
	gameEventsVMT->HookVM(Hooks::FireEventClientSide, 10);
	gameEventsVMT->ApplyVMT();

    inputInternalVMT = new VMT(inputInternal);
    inputInternalVMT->HookVM(Hooks::SetKeyCodeState, 92);
    inputInternalVMT->HookVM(Hooks::SetMouseCodeState, 93);
    inputInternalVMT->ApplyVMT();

    launcherMgrVMT = new VMT(launcherMgr);
    launcherMgrVMT->HookVM(Hooks::PumpWindowsMessageLoop, 19);
    launcherMgrVMT->ApplyVMT();

    materialVMT = new VMT(material);
    materialVMT->HookVM(Hooks::OverrideConfig, 21);
    materialVMT->HookVM(Hooks::BeginFrame, 42);
	materialVMT->ApplyVMT();

    modelRenderVMT = new VMT(modelRender);
    modelRenderVMT->HookVM(Hooks::DrawModelExecute, 21);
    modelRenderVMT->ApplyVMT();

    panelVMT = new VMT(panel);
    panelVMT->HookVM(Hooks::PaintTraverse, 42);
    panelVMT->ApplyVMT();

    soundVMT = new VMT(sound);
    soundVMT->HookVM( Hooks::EmitSound2, 6);
    soundVMT->ApplyVMT();

    surfaceVMT = new VMT(surface);
    surfaceVMT->HookVM(Hooks::OnScreenSizeChanged, 116);
	surfaceVMT->ApplyVMT();

    viewRenderVMT = new VMT(viewRender);
    viewRenderVMT->HookVM(Hooks::RenderView, 6 );
    viewRenderVMT->HookVM(Hooks::RenderSmokePostViewmodel, 42);
    viewRenderVMT->ApplyVMT();
    
	eventListener = new EventListener({ XORSTR("cs_game_disconnected"), XORSTR("player_connect_full"), XORSTR("player_death"), XORSTR("item_purchase"), XORSTR("item_remove"), XORSTR("item_pickup"), XORSTR("player_hurt"), XORSTR("bomb_begindefuse"), XORSTR("enter_bombzone"), XORSTR("bomb_beginplant"), XORSTR("switch_team") });

	if (Hooker::HookRecvProp(XORSTR("CBaseViewModel"), XORSTR("m_nSequence"), SkinChanger::sequenceHook))
		SkinChanger::sequenceHook->SetProxyFunction((RecvVarProxyFn) SkinChanger::SetViewModelSequence);

	//NetVarManager::DumpNetvars();

	//Settings::LoadSettings();

	srand(time(nullptr)); // Seed random # Generator so we can call rand() later

    // Build bonemaps here if we are already in-game
    if( engine->IsInGame() ){
        BoneMaps::BuildAllBonemaps();
    }

    cvar->ConsoleColorPrintf(ColorRGBA(0, 225, 0), XORSTR("\nFuzion Successfully loaded.\n"));
}
/* Entrypoint to the Library. Called when loading */
int __attribute__((constructor)) Startup()
{
	std::thread mainThread(MainThread);
	// The root of all suffering is attachment
	// Therefore our little buddy must detach from this realm.
	// Farewell my thread, may we join again some day..
	mainThread.detach();

	return 0;
}
/* Called when un-injecting the library */
void __attribute__((destructor)) Shutdown()
{
    if( Settings::SkyBox::enabled ){
        SetNamedSkyBox( cvar->FindVar("sv_skyname")->strValue );
    }
    cvar->FindVar(XORSTR("cl_mouseenable"))->SetValue(1);

	SDL2::UnhookWindow();
	SDL2::UnhookPollEvent();

	NoSmoke::Cleanup();
	TracerEffect::RestoreTracers();

    for( VMT* vmt : createdVMTs ){
        delete vmt;
    }

    input->m_fCameraInThirdPerson = false;
	input->m_vecCameraOffset.z = 150.f;
	GetLocalClient(-1)->m_nDeltaTick = -1;

	delete eventListener;

	*s_bOverridePostProcessingDisable = false;

	cvar->ConsoleColorPrintf(ColorRGBA(255, 0, 0), XORSTR("Fuzion Unloaded successfully.\n"));
}
